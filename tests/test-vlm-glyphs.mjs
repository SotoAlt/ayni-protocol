#!/usr/bin/env node
/**
 * VLM Glyph Recognition Test
 * Renders each glyph as a PNG, sends to Claude Vision, checks if it can identify it.
 */
import { createCanvas } from 'canvas';
import { readFileSync } from 'fs';
import { resolve } from 'path';

// Load API key from OpenClaw auth
const authPath = resolve(process.env.HOME, '.openclaw/agents/main/agent/auth-profiles.json');
const auth = JSON.parse(readFileSync(authPath, 'utf8'));
const API_KEY = auth.profiles['anthropic:default'].token;

const S = 16;
const SCALE = 20; // render at 320x320 for VLM readability
const BG = '#0a0e17';
const FG = '#00d9ff';

const GLYPHS = {
  Q01: {
    name: 'Query Database',
    grid: [
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,1,1,1,1,0,1,1,0,1,1,1,1,0,0],
      [0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0],
      [1,1,0,0,0,0,0,1,1,0,0,0,0,0,1,1],
      [0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],
      [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
      [0,1,1,0,1,1,0,0,0,0,1,1,0,1,1,0],
      [1,1,0,0,0,1,1,0,0,1,1,0,0,0,1,1],
    ],
  },
  Q02: {
    name: 'Search',
    grid: [
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
      [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
      [0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
      [0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],
      [1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1],
      [1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1],
      [1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1],
      [1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1],
      [1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1],
      [1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1],
      [0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0],
      [0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
      [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
    ],
  },
  Q03: {
    name: 'Query API',
    grid: [
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
    ],
  },
  R01: {
    name: 'Response Success',
    grid: [
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],
      [0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0],
      [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
      [0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0],
      [0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0],
    ],
  },
  E01: {
    name: 'Error',
    grid: [
      [1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1],
      [1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1],
      [0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0],
      [0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0],
      [0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0],
      [0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0],
      [0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0],
      [1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1],
      [1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1],
    ],
  },
  A01: {
    name: 'Execute Action',
    grid: [
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0],
      [0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],
      [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
      [0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
      [1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1],
      [1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1],
      [0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
      [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
      [0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],
      [0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
    ],
  },
  R02: {
    name: 'Data Response',
    grid: [
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,0,1,1,0,1,1,0,0,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0],
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0],
      [0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0],
    ],
  },
  R03: {
    name: 'Task Complete',
    grid: [
      [0,1,1,0,0,0,1,1,1,1,0,0,0,1,1,0],
      [0,1,1,0,0,1,1,1,1,1,1,0,0,1,1,0],
      [0,1,1,0,0,1,1,1,1,1,1,0,0,1,1,0],
      [0,1,1,0,0,0,1,1,1,1,0,0,0,1,1,0],
      [0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0],
      [0,0,1,1,0,0,1,1,1,1,0,0,1,1,0,0],
      [0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],
      [0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0],
      [0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0],
      [0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0],
    ],
  },
  E02: {
    name: 'Timeout',
    grid: [
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [1,1,0,0,1,1,1,1,1,1,1,1,0,0,1,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,0,0,1,1,0,1,1,1,1,0,1,1,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],
      [0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0],
      [0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],
    ],
  },
  E03: {
    name: 'Permission Denied',
    grid: [
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0],
      [0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0],
      [0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],
      [0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0],
      [0,1,1,0,0,0,0,1,1,0,0,0,0,1,1,0],
      [0,0,1,1,0,0,0,1,1,0,0,0,1,1,0,0],
      [0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,0,1,1,0,0,1,1,0,0,1,1,0,0,0],
      [0,0,0,0,1,1,0,1,1,0,1,1,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
    ],
  },
  A02: {
    name: 'Update Data',
    grid: [
      [0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0],
      [0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1],
      [1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1],
      [1,1,0,0,0,0,1,1,1,1,0,0,0,0,1,1],
      [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
      [0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0],
      [0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0],
      [0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0],
      [0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0],
      [1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1],
      [1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1],
    ],
  },
  A03: {
    name: 'Delegate Task',
    grid: [
      [0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0],
      [0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0],
      [0,1,1,0,1,1,0,0,0,0,1,1,0,1,1,0],
      [0,1,1,0,1,1,0,0,0,0,1,1,0,1,1,0],
      [0,1,1,0,1,1,1,1,1,1,1,1,0,1,1,0],
      [0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0],
      [0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,0,1,1,0,0,1,1,0,0,0,0,0],
      [0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0],
      [0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0],
    ],
  },
};

function renderGlyphPNG(grid) {
  const size = S * SCALE;
  const canvas = createCanvas(size, size);
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = BG;
  ctx.fillRect(0, 0, size, size);
  ctx.fillStyle = FG;
  for (let y = 0; y < S; y++)
    for (let x = 0; x < S; x++)
      if (grid[y][x]) ctx.fillRect(x * SCALE, y * SCALE, SCALE, SCALE);
  return canvas.toBuffer('image/png').toString('base64');
}

async function testGlyph(id, glyph) {
  const base64 = renderGlyphPNG(glyph.grid);

  const glyphDescriptions = Object.entries(GLYPHS).map(([gid, g]) => {
    const descs = {
      Q01: 'HUMANOID with arms angled UPWARD in V-shape, 3 SEPARATE horizontal bars on head, stepped feet',
      Q02: 'HOLLOW CIRCLE/RING outline, no limbs',
      Q03: 'UPWARD ARROW: solid triangle top + rectangular shaft bottom',
      R01: 'HUMANOID with arms AKIMBO (hands on hips), single THICK bar head, wide planted feet',
      E01: 'Bold X/CROSS — two thick DIAGONAL bars crossing',
      A01: 'HOLLOW DIAMOND outline, pointed top AND bottom',
      R02: 'HUMANOID with RING/HALO head (small hollow circle), arms angling DOWNWARD, thick BAR held at arm tips, straight narrow legs',
      R03: 'HUMANOID with BOTH ARMS STRAIGHT UP (two vertical columns flanking head), oval head between arms, wide V-legs',
      E02: 'BIRD/CONDOR — small head, SPREAD WINGS (full width), body narrows, FORKED TAIL at bottom',
      E03: 'SHIELD — wide flat top with cross pattern, TAPERS to point at bottom',
      A02: 'TANK ROBOT — dual antennas, round head, FULL-WIDTH body (16px block), V-legs to wide treads',
      A03: 'ROBOT — single antenna, SQUARE head, boxy body with HOLLOW WINDOW, detached side arm columns',
    };
    return `- ${gid} "${g.name}": ${descs[gid]}`;
  }).join('\n');

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': API_KEY,
      'anthropic-version': '2023-06-01',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-5-20250929',
      max_tokens: 300,
      messages: [{
        role: 'user',
        content: [
          {
            type: 'image',
            source: { type: 'base64', media_type: 'image/png', data: base64 },
          },
          {
            type: 'text',
            text: `This is a 16x16 pixel art glyph from the Ayni Protocol rendered in cyan on black.

The possible glyphs are:
${glyphDescriptions}

STEP 1: First describe what you ACTUALLY SEE in the image — overall shape, where pixels are concentrated, any distinctive features.
STEP 2: Is this a FIGURE (humanoid/robot/bird) or pure GEOMETRIC shape (circle/arrow/X/diamond/shield)?
STEP 3: Match to the glyph above. State the ID and why.`,
          },
        ],
      }],
    }),
  });

  const data = await response.json();
  const answer = data.content?.[0]?.text || data.error?.message || 'no response';
  return answer;
}

async function main() {
  console.log('=== VLM Glyph Recognition Test (12 glyphs) ===\n');

  let pass = 0, fail = 0;
  for (const [id, glyph] of Object.entries(GLYPHS)) {
    console.log(`Testing ${id} (${glyph.name})...`);
    const result = await testGlyph(id, glyph);
    const correct = result.includes(id);
    if (correct) pass++; else fail++;
    console.log(`  ${correct ? '✅' : '❌'} ${result.trim()}\n`);
  }

  console.log(`\n=== Results: ${pass}/${pass+fail} passed ===`);
}

main().catch(console.error);
